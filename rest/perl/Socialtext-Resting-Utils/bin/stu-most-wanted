#!/usr/bin/perl
use strict;
use warnings;
use Socialtext::Resting::Getopt qw/get_rester/;

my $r = get_rester();

warn "Fetching all pages...\n";
my @all_pages = $r->get_pages();
my $incipient_page_count;
my $page_wanters_count;
my %most_wanted;
for my $page (@all_pages) {
    warn "Fetching '$page'\n";
    $incipient_page_count++;
    my @incipient = $r->get_frontlinks($page, 1);
    for my $i (@incipient) {
        $page_wanters_count++;  
        push @{ $most_wanted{$i} }, $page;
    }
}

my $now = localtime;
my $new_page = "^^ Most Wanted Pages in " . $r->workspace . " at $now.\n"
             . "There are " . $incipient_page_count . " pages wanted by " . $page_wanters_count . " other pages.\n"
             . "This page is autogenerated by `st-most-wanted`\n\n"
             . "| *Wanted Page* | *Count* | *Wanters* |\n";

for my $i ( sort { @{ $most_wanted{$b} } <=> @{ $most_wanted{$a} } }
            keys %most_wanted ) {
    $new_page .= "| [$i] | " . @{ $most_wanted{$i} } . " | "
               . join(", ", map { "[$_]" } @{ $most_wanted{$i} })
               . " |\n";
}

warn "Putting most wanted pages page...\n";
$r->put_page('Most Wanted Pages', $new_page);
